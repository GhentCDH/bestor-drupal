# Bestor Drupal Docker

This repository contains the Drupal site for Bestor and is based on docker to provide the following services

- MySQL
- Elasticsearch
- Memcache
- [Drupal 10.3.6](https://hub.docker.com/_/drupal/tags?name=10.3.6) running PHP on Apache
- Adminer

This repository contains configuration files for the drupal site in `config/sync` directory.
The entrypoint of the drupal container makes sure that a drupal site is actually installed on the first run,
and imports the synced configurations from this directory. (see [`startup.sh`](./startup.sh))

Since this drupal site uses data from the original Bestor MediaWiki site, the database will have to be migrated using
the `migrate` crate in [Bestor-parser](https://github.com/GhentCDH/Bestor-parser/tree/main/migrate).
This migration also copies all media files from the MediaWiki to a configurable location.
These files should be copied to `initial-content` directory of this repository before starting the drupal site with the
`DRUPAL_RUN_IMAGE_IMPORT` set to `true` in the `.env` file.

## Getting started

If you have the command runner `just` installed, you can simply run:
`just rebuild` every time you want to start out fresh.

Otherwise, to start all services run
`docker compose up -d --build`

The startup script in the drupal container will take a while (especially on the first run).
To see what it is doing, you can run `docker logs bestor-drupal -f`.
Wait until you see `Running supervisord` or other apache-related log messages.

Then, you can open [localhost:8080](http://localhost:8080) to see the fresh install
of the Bestor drupal site.

To run `drush` open a command line in the container and simply run drush. It is available on PATH in the container.
If you have `just`, you can also do `just drush <command>` (e.g. `just drush cr`).

## Database

By default, the database will be empty.

To insert the mediawiki data, there are two options

### Using database dumps

Copy the database dump to `./initdb`.
When the database container starts, it will automatically load the dump into the database.

```
cp /path/to/mariadb-dump.sql ./initdb/0001_initial_dump.sql
docker compose stop db
docker volume rm bestor_db_data
docker compose up -d db
```

### Using the migrate crate

To migrate the data from the `output.json` that was generated by the `Bestor-parser` tool by interfacing
with the database directly, run `cargo run --release` from within [Bestor-parser](https://github.com/GhentCDH/Bestor-parser/tree/main/migrate).

Make sure that the environment variables are set up correctly.

### Initialize a new drupal database

To remove all databases, delete everything in
docker/data/db/data and restart the containers. The mediawiki databases should be restored from the database dumps in initdb.

The drupal database is created automatically but is completely empty. To initialize it go to the running drupal instance. To import config I had to do this:

```
drush entity:delete shortcut
drush entity:delete shortcut_set
drush cache-rebuild
drush config-get "system.site" uuid
```

Modify config/sync/system.site.yml to include `uuid: 15a433da-4371-4c9d-86b1-7bbcf299947d`. Finally run the import command wich now should run correctly:

```
drush config:import -y

[notice] Synchronized configuration: create views.view.who_s_new in language.nl.
[notice] Synchronized configuration: create views.view.who_s_online in language.nl.
[notice] Finalizing configuration synchronization.
[success] The configuration was imported successfully.
```

## Media files

The media files should be copied to the `initial-content` directory.
When starting the `drupal` container with `DRUPAL_RUN_IMAGE_IMPORT=true`, the media files will be imported automatically.

(generally, images should live in the `imported` directory within `initial-content`; `initial-content/imported/*`)

## Deployment

@hblomme, correct if wrong: export the drupal config to a set of yaml files in config/ , commit the yaml files and retstore the configuration on the server via drush?

Or via `Manage > Configuration > Development > Configuration synchronization`

See the drupal manual under [Managing your site's configuration](https://www.drupal.org/docs/administering-a-drupal-site/configuration-management/managing-your-sites-configuration)

## Configuration

All of the system configuration is done through environment variables that should be defined in a `.env` file.

An example `dev.env` file is provided with working default values for local development with docker compose.

Just copy it to `.env` and modify the values as needed.

## Credits

Development by [GhentCDH - Ghent University](https://www.ghentcdh.ugent.be/).

Funded by the [GhentCDH research projects](https://www.ghentcdh.ugent.be/projects).
