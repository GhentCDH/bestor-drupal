<?php

use Drupal\relationship_nodes_search\Form\ExtendedIndexAddFieldsForm;
// weg na debug
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;

function relationship_nodes_search_module_implements_alter(&$implementations, $hook) {
  if ($hook === 'search_api_query_alter') {
    if (isset($implementations['relationship_nodes_search'])) {
      $implementation = $implementations['relationship_nodes_search'];
      unset($implementations['relationship_nodes_search']);
      $implementations['relationship_nodes_search'] = $implementation;
    }
  }
}

function relationship_nodes_search_theme() {
  return [
    'relationship_field' => [
      'variables' => ['relationships' => [], 'grouped' => [], 'summary' => [], 'fields' => [], 'row' => NULL],
      'template' => 'relationship-field',
    ],
  ];
}

function relationship_nodes_search_entity_type_alter(array &$entity_types) {
  if (isset($entity_types['search_api_index'])) {
    $entity_types['search_api_index']->setFormClass('add_fields', ExtendedIndexAddFieldsForm::class);
  }
}

function relationship_nodes_search_search_api_field_type_mapping_alter(array &$mapping) {
 $mapping['relation_info'] = 'relationship_nodes_search_nested_relationship';
}

function relationship_nodes_search_facets_search_api_query_type_mapping_alter($backend_plugin_id, array &$query_types){
  $query_types['relationship_nodes_search_nested_relationship'] = 'search_api_nested';
}











// weg

function relationship_nodes_search_form_search_api_index_edit_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Only show if current user is admin
  if (!\Drupal::currentUser()->hasPermission('administer search_api')) {
    return;
  }
  
  $form['relationship_debug'] = [
    '#type' => 'container',
    '#title' => 'DEBUG: Test Cleanup Logic',
    '#attributes' => [
      'style' => 'background: #fff3cd; border: 3px solid #ffc107; padding: 15px; margin-bottom: 20px;',
    ],
    '#weight' => -999,
  ];
  
  $form['relationship_debug']['info'] = [
    '#markup' => '<p><strong> TEMPORARY DEBUG BUTTON</strong></p>',
  ];
  
  $form['relationship_debug']['test'] = [
    '#type' => 'submit',
    '#value' => t('ðŸ” Analyze (DPM)'),
    '#submit' => ['relationship_nodes_search_debug_analyze'],
    '#limit_validation_errors' => [],
  ];
  

}

/**
 * Debug: Analyze current state with dpm().
 */
function relationship_nodes_search_debug_analyze(array &$form, FormStateInterface $form_state) {
    $index_storage = \Drupal::entityTypeManager()->getStorage('search_api_index');
    $indexes = $index_storage->loadMultiple();
    dpm($indexes);
    $nested_fields_by_index = [];
    foreach ($indexes as $index_id => $index) {
      $nested_field_ids = [];
      
      // Find fields using our processor
      foreach ($index->getFields() as $field_id => $field) {
        $field_config = $field->getConfiguration();
        if (!empty($field_config['nested_fields'])) {
          $nested_field_ids[] = $field_id;
        }
      }
      $nested_fields_by_index[$index_id] = [
        'index' => $index,
        'nested_field_ids' => $nested_field_ids
      ];
    }
    // Clean up Search API indexes
  //_relationship_nodes_search_cleanup_indexes($nested_fields_by_index);
  
  // Clean up Views
  _relationship_nodes_search_cleanup_views($nested_fields_by_index);
  
  $form_state->setRebuild(TRUE);
}


  // Clean up Search API indexes
  function _relationship_nodes_search_cleanup_indexes(array $nested_fields_by_index){

  
  foreach ($nested_fields_by_index as $index_id => $nested_info) {
    $index = $nested_info['index'];
    foreach ($nested_info['nested_field_ids'] as $field_id) {
      try {
        $index->removeField($field_id);
        \Drupal::logger('relationship_nodes_search')->notice(
          'Removed field @field from index @index',
          ['@field' => $field_id, '@index' => $index->id()]
        );
      }
      catch (\Exception $e) {
        \Drupal::logger('relationship_nodes_search')->error(
          'Failed to remove field @field from index @index: @message',
          [
            '@field' => $field_id,
            '@index' => $index->id(),
            '@message' => $e->getMessage()
          ]
        );
      }
    }
    // Remove processor
    if ($index->isValidProcessor('relationship_indexer')) {
      $processors = $index->getProcessors();
      unset($processors['relationship_indexer']);
      $index->setProcessors($processors);
    }
    
    // Save index
    try {
      //prevent execution for testing
      //$index->save();
      \Drupal::messenger()->addStatus(t('Cleaned up index: @index', ['@index' => $index->label()]));
    }
    catch (\Exception $e) {
      \Drupal::messenger()->addError(t('Failed to clean up index @index: @message', [
        '@index' => $index->label(),
        '@message' => $e->getMessage()
      ]));
      
    }
  }
}


  
  // Clean up Views
  function _relationship_nodes_search_cleanup_views($nested_fields_by_index) {
  $view_storage = \Drupal::entityTypeManager()->getStorage('view');
  $views = $view_storage->loadMultiple();
  
  $fields_by_base_table = [];

  foreach ($nested_fields_by_index as $index_id => $nested_info) {
    $base_table = 'search_api_index_' . $index_id;
    $fields_by_base_table[$base_table] = $nested_info['nested_field_ids'];
  }

  foreach ($views as $view) {
    $base_table = $view->get('base_table');
    
    // Skip views that are not based on a search api index with nested fields
    if (!isset($fields_by_base_table[$base_table])) {
      continue;
    }
    
    $changed = false;
    $nested_field_ids = $fields_by_base_table[$base_table];
    
    // Get all displays as an array we can modify
    $displays = $view->get('display');
    
    foreach ($displays as $display_id => &$display) {
      // Remove filters
      if (!empty($display['display_options']['filters'])) {
        foreach ($display['display_options']['filters'] as $filter_id => $filter) {
          $remove_filter = false;
          
          if (($filter['plugin_id'] ?? '') === 'search_api_relationship_filter') {
            $remove_filter = true;
          } elseif(isset($filter['field'])) {
            $field_name = str_replace('facets_', '', $filter['field']);
            if (in_array($field_name, $nested_field_ids, TRUE)) {
               $remove_filter = true;
            }
          }
          if($remove_filter === true){
            dpm($filter, 'filter van view die verwijderd moet worden');
            unset($display['display_options']['filters'][$filter_id]);
            $changed = true;
          }
        }
      }
      
      // Remove fields
      if (!empty($display['display_options']['fields'])) {
        foreach ($display['display_options']['fields'] as $field_id => $field) {

          if (isset($field['field']) && in_array($field['field'], $nested_field_ids, TRUE)) {
            unset($display['display_options']['fields'][$field_id]);
            $changed = TRUE;
          }
        }
      }
    }
 
    if ($changed) {
      // Apply modified displays back to view
      $view->set('display', $displays);
      
      try {
        // Prevent execution for testing - UNCOMMENT TO ACTUALLY SAVE
        // $view->save();
        
        \Drupal::messenger()->addStatus(t('Would clean up view: @view', [
          '@view' => $view->label(),
        ]));
      }
      catch (\Exception $e) {
        \Drupal::messenger()->addError(t('Failed to clean up view @view: @message', [
          '@view' => $view->label(),
          '@message' => $e->getMessage()
        ]));
      }
    }
  }
}