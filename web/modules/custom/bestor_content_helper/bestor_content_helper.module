<?php

/**
 * @file
 * Main module file for Bestor Nodes Helper.
 */

use Drupal\node\NodeInterface;
use Drupal\Core\Breadcrumb\Breadcrumb;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Link;
use Drupal\Core\Url;
use Drupal\node\Entity\NodeType;
use Drupal\views\Views;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Field\FieldItemListInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\FieldableEntityInterface;
use Drupal\Component\Utility\Html;


/**
 * Implements hook_node_presave().
 */
function bestor_content_helper_node_presave(NodeInterface $node) {
  \Drupal::service('bestor_content_helper.node_language_analyzer')
    ->ensureDefaultTranslationTitle($node);
}


/**
 * Implements hook_preprocess_menu().
 */
function bestor_content_helper_preprocess_menu(&$variables) {
  if ($variables['menu_name'] !== 'main') {
    return;
  }

  $disciplines_key = NULL;
  foreach ($variables['items'] as $key => $item) {
    if (isset($item['title']) && in_array($item['title'], ['Disciplines'])) {
      $disciplines_key = $key;
      break;
    }
  }

  if (!$disciplines_key) {
    return;
  }

  $facet_provider = \Drupal::service('bestor_content_helper.facet_results_provider');
  $discipline_items = $facet_provider->getFacetResultMenuItems(
    'database', 
    'facets_tax_discipline__int', 
    'discipline', 
    'page_1'
  );

  $variables['items'][$disciplines_key]['below'] = $discipline_items;
  $variables['items'][$disciplines_key]['is_expanded'] = TRUE;
}


/**
 * Implements hook_node_view().
 */
function bestor_content_helper_node_view(array &$build, NodeInterface $node, $view_mode, $langcode) {
  $service =  \Drupal::service('bestor_content_helper.standard_node_field_processor');
  $service->getLemmaKeyData($node);
}


/**
 * Implements hook_system_breadcrumb_alter().
 */
function bestor_content_helper_system_breadcrumb_alter(Breadcrumb &$breadcrumb, RouteMatchInterface $route_match, array $context) {
    if ($node = $route_match->getParameter('node')) {
    $bundle = $node->bundle();

    $nodeContentAnalyzer =  \Drupal::service('bestor_content_helper.node_content_analyzer');
    
    $links = [];
    if ($nodeContentAnalyzer->isLemma($bundle)) {   
      $links[] = Link::createFromRoute(t('Home'), '<front>');
      $links[] = _getViewLink('database', 'page_1');
      $links[] = Link::fromTextAndUrl(
        t(NodeType::load($node->bundle())->label()), 
        Url::fromRoute('view.database.page_1', [], ['query' => ['category['. $bundle . ']' => $bundle]])
      );

    } elseif ($bundle === 'article') {
      $links[] = Link::createFromRoute(t('Home'), '<front>');
      $links[] = _getViewLink('announcements', 'page_2');
      
    } elseif ($bundle === 'event') {
      $links[] = Link::createFromRoute(t('Home'), '<front>');
      $links[] = _getViewLink('announcements', 'page_3');
    }
      
    if($links){
      $breadcrumb = new Breadcrumb();
      $breadcrumb->setLinks($links);
      $breadcrumb->addCacheContexts(['route']);
      $breadcrumb->addCacheTags(['node:' . $node->id()]);
    }
  }
}


/**
 * Implements hook_field_widget_single_element_form_alter().
 */
function  bestor_content_helper_field_widget_single_element_form_alter(array &$element, FormStateInterface $form_state, array $context) {
  // Voor paragraph edit forms
  if (empty($element['#paragraph_type']) || 
      !in_array($element['#paragraph_type'], ['media', 'text_media']) ||
      empty($element['subform']['field_cardinality_exception']) ||
      !isset($element['#delta'])  
  ) {
    return;
  }

  if(isset($element['subform']['field_media_multiple'])){
    $element['subform']['field_media_multiple']['#states'] = [
      'visible' => [
        ':input[name="field_description[' . $element['#delta'] . '][subform][field_cardinality_exception][value]"]' => ['checked' => TRUE],
      ],
    ];
  }

  if(isset($element['subform']['field_media_multiple'])){
    $element['subform']['field_media']['#states'] = [
      'visible' => [
        ':input[name="field_description[' . $element['#delta'] . '][subform][field_cardinality_exception][value]"]' => ['checked' => FALSE],
      ],
    ];
  }
}


/**
 * Implements hook_entity_presave.
 */
function bestor_content_helper_entity_presave(EntityInterface $entity) : void {
  if(!in_array($entity->getEntityTypeId(), ['node', 'paragraph'])){
    return;
  }
  $fields_to_update = ['body', 'field_formatted_text', 'field_table', 'field_references'];
  $needs_update = [];
  foreach($fields_to_update as $field_name) {
    dpm($entity->hasField($field_name));
  
    if ($entity->hasField($field_name) && !empty($entity->get($field_name)->getValue())) {
      
      $field_content = $entity->get($field_name)->getValue()[0]['value'];
      if(!empty($field_content)) {
        $needs_update[$field_name] = $field_content;
      }
    }
    if(!empty($needs_update)) {
      _convertHyperlinks($entity, $needs_update);
    }
  }
}


/**
 * Helper function: get url of page view by view and display id.
 */
function _getViewLink($view_id, $display_id){
  $view = Views::getView($view_id);
  $view->setDisplay($display_id);
  return Link::fromTextAndUrl(
    $view->getTitle(), 
    Url::fromRoute('view.' . $view_id . '.' . $display_id, [], [])
  );
}


/**
 * Helper function: convert hyperlinks to entity links.
 */
function _convertHyperlinks(FieldableEntityInterface &$entity, $fields_to_update) {
  $entity_type_manager = \Drupal::entityTypeManager();
  $path_alias_manager = \Drupal::service('path_alias.manager');
  
  // Allowed hostnames
  $allowed_hosts = ['bestor.be', 'bestor.ugent.be', 'localhost', '127.0.0.1'];

  foreach($fields_to_update as $field_name => $content) {
    $doc = Html::load($content);
    $changed = FALSE;

    foreach ($doc->getElementsByTagName('a') as $element) {
      // Skip if already has Linkit attributes
      if (!empty($element->getAttribute('data-entity-uuid'))) {
        continue;
      }

      $href = $element->getAttribute('href');
      if (empty($href)) {
        continue;
      }
      
      $parsed = parse_url($href);


      // Check if internal link
      if (!empty($parsed['host'])) {
        $is_internal = FALSE;
        foreach ($allowed_hosts as $allowed) {
          if (str_contains(strtolower($parsed['host']), $allowed)) {
            $is_internal = TRUE;
            break;
          }
        }
        if (!$is_internal) {
          continue;
        }
      }

      // Skip mailto links
      if (!empty($parsed['scheme']) && $parsed['scheme'] == 'mailto') {
        continue;
      }

      // Skip empty, homepage, or anchors
      if (empty($parsed['path']) || $parsed['path'] === '/' || str_starts_with($parsed['path'], '#')) {
        continue;
      }

      $path = $parsed['path'];
      if (!str_starts_with($path, '/')) {
        $path = '/' . $path;
      }

      // FIX BROKEN PATHS: /123 â†’ /node/123
      if (preg_match('#^/([a-z]{2}/)?(\d+)$#', $path, $matches)) {
        $language_prefix = $matches[1] ?? '';
        $entity_id = $matches[2];
        
        // Try to load as node first
        $test_entity = $entity_type_manager->getStorage('node')->load($entity_id);
        if ($test_entity) {
          $path = '/' . $language_prefix . 'node/' . $entity_id;
        }
        else {
          // Entity doesn't exist
          continue;
        }
      }
      try {
        $url = Url::fromUri("internal:" . $path);
      }
      catch (InvalidArgumentException $e) {
        continue;
      }

      if (!($url->isRouted() && str_starts_with($url->getRouteName(), 'entity.'))) {
        // Not an entity route.
        continue;
      }

      $route = $url->getRouteParameters();
      $entity_type = key($route);
      if (!in_array($entity_type, ['node'])) {
        // Not an entity type to link.
        continue;
      }

      $linked_entity = $entity_type_manager->getStorage($entity_type)->load($route[$entity_type]);
      if ($linked_entity) {
        // Add data attributes same as when created in CKEditor.
        // Linkit.
        $element->setAttribute('data-entity-type', $entity_type);
        $element->setAttribute('data-entity-substitution', 'canonical');
        $element->setAttribute('data-entity-uuid', $linked_entity->uuid());
        $system_path = $path_alias_manager->getPathByAlias($path);
        $element->setAttribute('href', $system_path);
        $changed = TRUE;
      }
    }

    if ($changed) {
      $content = $doc->saveHTML();
      $content = Html::decodeEntities(Html::serialize($doc));
      $entity->$field_name->value = $content;
    }
  }
}
